<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Daniel J. Harvey - Let's write a database (part 1)</title>
    <link rel="stylesheet" href="../css/default.css" />

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RKDYZB38Z0"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-RKDYZB38Z0');
    </script>
</head>

<body>
    <header>
        <div class="logo">
            <a href="../">Daniel J. Harvey</a>
        </div>
        <nav>
            <a href="../">Home</a>
            <a href="../contact.html">Contact</a>
            <a href="../archive.html">Archive</a>
        </nav>
    </header>

    <main role="main">
        <h1>Let's write a database (part 1)</h1>
        <article>
    <section class="header">
        Posted on July 26, 2025
        
        <div class="info">
          
          Tags: <a title="All pages tagged 'database'." href="../tags/database.html" rel="tag">database</a>, <a title="All pages tagged 'filter'." href="../tags/filter.html" rel="tag">filter</a>, <a title="All pages tagged 'from'." href="../tags/from.html" rel="tag">from</a>, <a title="All pages tagged 'project'." href="../tags/project.html" rel="tag">project</a>
          
        </div>
    </section>
    <section>
        <p>So, confession, I love playing on the computer, but I’m terrible at SQL. I know that it’s Good or whatever and there’s this whole very sensible looking <a href="https://en.wikipedia.org/wiki/Relational_algebra">Relational Algebra</a> behind it all, but like when I have to interact with it, I get the job done and then immediately wipe whatever I learned from my brain.</p>
<p>Enough is enough. It’s time to learn it properly. And what better way than to write an ANSI SQL database from scratch!</p>
<h2 id="disclaimers-etc">Disclaimers etc</h2>
<p>Setting some expectations, this is very much a “fun” learning project, and we’re gonna get a lot of things wrong. We’ll be using Rust, because I write that a lot atm and so it’s what my brain thinks in, but I would definitely not read this hoping for a Rust tutorial because I am almost as bad at Rust as SQL. I am going to describe things in a very hand-wavy way that will probably annoy people that know what they’re talking about, but it’s my blog and I can do what I want.</p>
<h2 id="so-lets-do-it">So, let’s do it?</h2>
<p>OK. So what we’re going to do in part 1 is:</p>
<ul>
<li>Make (steal) a SQL parser</li>
<li>Do a table scan (<code>From</code>)</li>
<li>Filter results from that table (<code>Filter</code>)</li>
<li>Choose the fields we want to look at (<code>Project</code>)</li>
</ul>
<p>We’re going to be concentrating on the Query Engine part of the database initially,mostly because I’m more interested in it, so our tables are going to be static JSON files taken from the <a href="https://github.com/marko-knoebl/chinook-database-json">chinook dataset</a>. We are using this because it’s full of rock albums and it’s nice to be reminder that Led Zeppelin are a totally sick band from time to time.</p>
<h2 id="our-types">Our types</h2>
<p>We might not be implementing in Haskell but it’s spirit lives on - let’s start by defining the types of our query.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// the type that defines a query</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> Query <span class="op">{</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">From</span>(<span class="bu">From</span>)<span class="op">,</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  Filter(Filter)<span class="op">,</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  Project(Project)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">// select `FROM` a table</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> <span class="bu">From</span> <span class="op">{</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  table_name<span class="op">:</span> TableName</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">// filter the results for a `WHERE` clause</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Filter <span class="op">{</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  from<span class="op">:</span> <span class="dt">Box</span><span class="op">&lt;</span>Query<span class="op">&gt;,</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  filter<span class="op">:</span> Expr<span class="op">,</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co">// boolean expression type</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> Expr <span class="op">{</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  ColumnComparison <span class="op">{</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    column<span class="op">:</span> Column<span class="op">,</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    op<span class="op">:</span> Op<span class="op">,</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    literal<span class="op">:</span> <span class="pp">serde_json::</span>Value<span class="op">,</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="co">// compare two items  </span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> Op <span class="op">{</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  Equals<span class="op">,</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="co">// choose which fields to return </span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Project <span class="op">{</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  from<span class="op">:</span> <span class="dt">Box</span><span class="op">&lt;</span>Query<span class="op">&gt;,</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  fields<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>ColumnName<span class="op">&gt;</span> </span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="co">// name of a table</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> TableName(<span class="kw">pub</span> <span class="dt">String</span>)<span class="op">;</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="co">// name of a column</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> ColumnName(<span class="kw">pub</span> <span class="dt">String</span>)<span class="op">;</span></span></code></pre></div>
<h2 id="a-parser">A parser</h2>
<p>This could quickly become a parsing tutorial and we don’t want that, so we’re going to use the <a href="https://docs.rs/sqlparser/latest/sqlparser">sqlparser</a> crate. It takes a string input and returns either it’s own AST or an error. We’ll pattern match on this and extract only the things we support into a <code>Query</code> type we defined above.</p>
<p>Nothing about this is very interesting, so I will just <a href="https://github.com/danieljharvey/lets-build-a-database/blob/main/crates/core/src/parser.rs#L51">link to it</a>. Know that we parse some SQL and make the types above.</p>
<h2 id="our-run_query-function">Our <code>run_query</code> function</h2>
<p>Now we’ve worked out what the user wants, we need to run the query. Initially we’ll do this by matching on the <code>Query</code> type.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> run_query(query<span class="op">:</span> <span class="op">&amp;</span>Query) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="pp">serde_json::</span>Value<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">match</span> query <span class="op">{</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="pp">Query::</span><span class="bu">From</span>(_) <span class="op">=&gt;</span> <span class="pp">todo!</span>(<span class="st">&quot;Query::From&quot;</span>)<span class="op">,</span> </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="pp">Query::</span>Filter(_) <span class="op">=&gt;</span> <span class="pp">todo!</span>(<span class="st">&quot;Query::Filter&quot;</span>)<span class="op">,</span> </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="pp">Query::</span>Project(_) <span class="op">=&gt;</span> <span class="pp">todo!</span>(<span class="st">&quot;Query::Project&quot;</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>We’ll fill these <code>todo!</code> out one by one now.</p>
<h2 id="queryfrom">Query::From</h2>
<p>The first thing we’ll implement is a simple table scan. A table scan is “get all of the rows in the table”. If you’re thinking “that doesn’t sound wildly performant”, rest assured your Software Craftsperson spidey-sense is still working correctly. However, our tables only have ~300 items in them, so for now we’ll live with it until we start thinking about indexes.</p>
<p>Here is some code. Forgive me, Padre.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> table_scan(table_name<span class="op">:</span> <span class="op">&amp;</span>TableName) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="pp">serde_json::</span>Value<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">match</span> table_name<span class="op">.</span><span class="dv">0</span><span class="op">.</span>as_str() <span class="op">{</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Album&quot;</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> my_str <span class="op">=</span> <span class="pp">include_str!</span>(<span class="st">&quot;../static/Album.json&quot;</span>)<span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>      <span class="pp">serde_json::from_str::</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span><span class="pp">serde_json::</span>Value<span class="op">&gt;&gt;</span>(my_str)<span class="op">.</span>unwrap()</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">},</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Artist&quot;</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> my_str <span class="op">=</span> <span class="pp">include_str!</span>(<span class="st">&quot;../static/Artist.json&quot;</span>)<span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>      <span class="pp">serde_json::from_str::</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span><span class="pp">serde_json::</span>Value<span class="op">&gt;&gt;</span>(my_str)<span class="op">.</span>unwrap()</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    _ <span class="op">=&gt;</span> <span class="pp">panic!</span>(<span class="st">&quot;table not found {table_name:?}&quot;</span>)<span class="op">,</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Let’s smash that into our <code>run_query</code> function:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> run_query(query<span class="op">:</span> <span class="op">&amp;</span>Query) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="pp">serde_json::</span>Value<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">match</span> query <span class="op">{</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="pp">Query::</span><span class="bu">From</span>(<span class="bu">From</span> <span class="op">{</span> table_name <span class="op">}</span>) <span class="op">=&gt;</span> table_scan(table_name)<span class="op">,</span> </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ..  </span></span></code></pre></div>
<p>It is not good code, but it is code. We’d test it, but it would still fail because of the other <code>todo!</code>. Oh well. Onwards.</p>
<h2 id="queryfilter">Query::Filter</h2>
<p>Call me a staunch traditionalist, but often when I am accessing a database I do not wish to download all of it’s data at once. We’re going to allow users to filter data using a <code>where</code> clause, which lets us define properties about rows we are interested in.</p>
<p>Let’s recap on our <code>Expr</code> type:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> Expr <span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  ColumnComparison <span class="op">{</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    column<span class="op">:</span> Column<span class="op">,</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    op<span class="op">:</span> Op<span class="op">,</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    literal<span class="op">:</span> <span class="pp">serde_json::</span>Value<span class="op">,</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">},</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> Op <span class="op">{</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  Equals<span class="op">,</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This is pretty limited, but it does let us express <code>select * from Album where album_id = 1</code>.</p>
<p>We start by defining a function for deciding whether we care about a row. It takes a row (which we store as a <code>serde_json::Value</code>) and an <code>Expr</code>, returning a <code>bool</code> telling us to keep the row or throw it in the bin.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> apply_predicate(row<span class="op">:</span> <span class="op">&amp;</span><span class="pp">serde_json::</span>Value<span class="op">,</span> where_expr<span class="op">:</span> <span class="op">&amp;</span>Expr) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">match</span> where_expr <span class="op">{</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="pp">Expr::</span>ColumnComparison <span class="op">{</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>      column<span class="op">,</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>      op<span class="op">,</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>      literal<span class="op">,</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>      <span class="co">// unwrap row into a map</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> row_object <span class="op">=</span> row<span class="op">.</span>as_object()<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>      <span class="co">// grab the column we care about </span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> value <span class="op">=</span> row_object<span class="op">.</span>get(<span class="op">&amp;</span>column<span class="op">.</span>name)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>      <span class="co">// compare it to `value` </span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">match</span> op <span class="op">{</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="pp">Op::</span>Equals <span class="op">=&gt;</span> value <span class="op">==</span> literal<span class="op">,</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Let’s use it in our <code>run_query</code> function:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> run_query(query<span class="op">:</span> <span class="op">&amp;</span>Query) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="pp">serde_json::</span>Value<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">match</span> query <span class="op">{</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="pp">Query::</span><span class="bu">From</span>(<span class="bu">From</span> <span class="op">{</span> table_name <span class="op">}</span>) <span class="op">=&gt;</span> table_scan(table_name)<span class="op">,</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="pp">Query::</span>Filter(Filter <span class="op">{</span> from<span class="op">,</span> filter <span class="op">}</span>) <span class="op">=&gt;</span> run_query(from)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>into_iter()</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>filter(<span class="op">|</span>row<span class="op">|</span> apply_predicate(row<span class="op">,</span> filter))</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>collect()<span class="op">,</span> </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>      <span class="co">// ..</span></span></code></pre></div>
<p>We’d test a query, but it’d still fail. But nearly!</p>
<h2 id="queryproject">Query::Project</h2>
<p>So far we return every single field from our table scan, so every <code>select</code> is a <code>select * from ...</code>. We can do better than that, let’s implement <code>Project</code>, which is how we extract fields from rows. Eventually, we’ll allowing renaming things with aliases, but that’s quite boring and fiddly, so for now we’re just supporting stuff like <code>select Title, ArtistId from Album</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> project_fields(row<span class="op">:</span> <span class="pp">serde_json::</span>Value<span class="op">,</span> fields<span class="op">:</span> <span class="op">&amp;</span>[Column]) <span class="op">-&gt;</span> <span class="pp">serde_json::</span>Value <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// make set of columns to keep</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> field_set<span class="op">:</span> BTreeSet<span class="op">&lt;</span>_<span class="op">&gt;</span> <span class="op">=</span> </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    fields</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>iter()</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>map(<span class="op">|</span>c<span class="op">|</span> c<span class="op">.</span>name<span class="op">.</span>clone())</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>collect()<span class="op">;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="kw">let</span> <span class="pp">serde_json::Value::</span>Object(map) <span class="op">=</span> row <span class="op">{</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// collect all the items we still want</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> new_map <span class="op">=</span> map</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>into_iter()</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>filter(<span class="op">|</span>(k<span class="op">,</span> _)<span class="op">|</span> field_set<span class="op">.</span>contains(k))</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>collect()<span class="op">;</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// wrap it back up again</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="pp">serde_json::Value::</span>Object(new_map)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="pp">panic!</span>(<span class="st">&quot;expected Object&quot;</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Then we add it to <code>run_query</code>, completing it for now.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> run_query(query<span class="op">:</span> <span class="op">&amp;</span>Query) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="pp">serde_json::</span>Value<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">match</span> query <span class="op">{</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="pp">Query::</span><span class="bu">From</span>(<span class="bu">From</span> <span class="op">{</span> table_name <span class="op">}</span>) <span class="op">=&gt;</span> table_scan(table_name)<span class="op">,</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="pp">Query::</span>Filter(Filter <span class="op">{</span> from<span class="op">,</span> filter <span class="op">}</span>) <span class="op">=&gt;</span> run_query(from)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>into_iter()</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>filter(<span class="op">|</span>row<span class="op">|</span> apply_predicate(row<span class="op">,</span> filter))</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>collect()<span class="op">,</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="pp">Query::</span>Project(Project <span class="op">{</span> from<span class="op">,</span> fields <span class="op">}</span>) <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>      <span class="co">// filter the columns in each row</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>      run_query(from)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>into_iter()</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>map(<span class="op">|</span>row<span class="op">|</span> project_fields(row<span class="op">,</span> fields))</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>collect()<span class="op">,</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="bringing-it-together">Bringing it together</h2>
<p>We then add a basic CLI using <a href="https://docs.rs/clap/latest/clap/">clap</a>, that takes a single argument <code>--sql</code>. Nothing surprising or interesting here, sorry.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">clap::</span>Parser<span class="op">;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">core::</span><span class="op">{</span>parse<span class="op">,</span> run_query<span class="op">};</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span>Parser<span class="op">,</span> <span class="bu">Debug</span><span class="at">)]</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>command<span class="at">(</span>version<span class="op">,</span> about<span class="op">,</span> long_about <span class="op">=</span> <span class="cn">None</span><span class="at">)]</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Args <span class="op">{</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// SQL query to run</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">#[</span>arg<span class="at">(</span>short<span class="op">,</span> long<span class="at">)]</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  sql<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> main() <span class="op">{</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> args <span class="op">=</span> <span class="pp">Args::</span>parse()<span class="op">;</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> query <span class="op">=</span> parse(<span class="op">&amp;</span>args<span class="op">.</span>sql)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> results <span class="op">=</span> run_query(<span class="op">&amp;</span>query)<span class="op">;</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> result <span class="kw">in</span> results <span class="op">{</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span class="pp">println!</span>(<span class="st">&quot;{result}&quot;</span>)<span class="op">;</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This means we can run a query with <code>cargo run --bin cli -- --sql 'select Title from Album where AlbumId = 48' | jq</code> and look what we get:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;AlbumId&quot;</span><span class="ex">:</span> 48,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Title&quot;</span><span class="ex">:</span> <span class="st">&quot;The Essential Miles Davis (Disc 1)&quot;</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;ArtistId&quot;</span><span class="ex">:</span> 68</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>Not bad, not bad at all.</p>
<h2 id="whats-next">What’s next?</h2>
<p>If you’ve made it this far without being furious about my use of <code>unwrap()</code>, then in part two we’re going to add some JOINS.</p>
<p>Make sense? If not, <a href="../contact.html">get in touch</a>!</p>
    </section>
</article>

    </main>

    <footer>
      <p>Site proudly generated by
      <a href="http://jaspervdj.be/hakyll">Hakyll</a></p>
      <p>Links for nerds:
        <a href="../atom.xml">atom</a>
        <a href="../rss.xml">rss</a></p>

    </footer>
</body>

</html>
