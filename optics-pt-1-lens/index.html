<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Daniel J. Harvey - Why The Hell Should I Care About Lens? (Part 1)</title>
    <link rel="stylesheet" href="https://danieljharvey.github.io/main.css">

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RKDYZB38Z0"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-RKDYZB38Z0');
    </script>
</head>

<body>
    <header>
        <div class="logo">
            <a href="/">Daniel J. Harvey</a>
        </div>
        <nav>
            <a href="/">Posts</a>
        </nav>
    </header>

    <main role="main">
        
<h1 class="title">
  Why The Hell Should I Care About Lens? (Part 1)
</h1>
<p class="subtitle"><strong>2018-10-30</strong></p>
<p>
 <p class="blog-meta">
        
        <a href="https:&#x2F;&#x2F;danieljharvey.github.io/tags/haskell/"
          >#haskell</a
        > 
        <a href="https:&#x2F;&#x2F;danieljharvey.github.io/tags/optics/"
          >#optics</a
        >
         
      </p>

<p>Lenses are a thing that Haskell people talk about a lot. They bloody love a lens. Everywhere you go, lens, lens, lens. What is lens? Should we, mere mortals, care?</p>
<p>Let's try and find out what the big deal is.</p>
<p>So.</p>
<p>Immutability is great, but it does mean that updating a value that lives deep within a big data structure can become an utter pain in the arse. Let's define a data structure:</p>
<pre data-lang="haskell" style="background-color:#2b303b;color:#c0c5ce;" class="language-haskell "><code class="language-haskell" data-lang="haskell"><span style="color:#b48ead;">data </span><span style="color:#d08770;">AppConfig </span><span>= </span><span style="color:#d08770;">AppConfig</span><span> { value    :: </span><span style="color:#d08770;">Either String Int
</span><span>                           , title    :: </span><span style="color:#d08770;">String
</span><span>                           , dbConfig :: </span><span style="color:#d08770;">DbConfig
</span><span>                           } </span><span style="color:#b48ead;">deriving</span><span> (</span><span style="color:#a3be8c;">Show</span><span>)
</span></code></pre>
<p>It contains <code>DbConfig</code> which looks like this:</p>
<pre data-lang="haskell" style="background-color:#2b303b;color:#c0c5ce;" class="language-haskell "><code class="language-haskell" data-lang="haskell"><span style="color:#b48ead;">data </span><span style="color:#d08770;">DbConfig </span><span>= </span><span style="color:#d08770;">DbConfig</span><span> { ipAddress :: </span><span style="color:#d08770;">String
</span><span>                         , thePort   :: </span><span style="color:#d08770;">Int
</span><span>                         } </span><span style="color:#b48ead;">deriving</span><span> (</span><span style="color:#a3be8c;">Show</span><span>)
</span></code></pre>
<p>And here is an example of the data:</p>
<pre data-lang="haskell" style="background-color:#2b303b;color:#c0c5ce;" class="language-haskell "><code class="language-haskell" data-lang="haskell"><span style="color:#8fa1b3;">appData </span><span style="color:#b48ead;">:: AppConfig
</span><span>appData = </span><span style="color:#d08770;">AppConfig</span><span> {
</span><span>    value = </span><span style="color:#d08770;">Right 100
</span><span>  , title = &quot;</span><span style="color:#a3be8c;">Hello</span><span>&quot;
</span><span>  , dbConfig = </span><span style="color:#d08770;">DbConfig</span><span> {
</span><span>      ipAddress = &quot;</span><span style="color:#a3be8c;">127.0.0.1</span><span>&quot;
</span><span>    , thePort = </span><span style="color:#d08770;">8080
</span><span>  }
</span><span>}
</span></code></pre>
<p>How would we get data from this structure in something like javascript?</p>
<pre data-lang="javascript" style="background-color:#2b303b;color:#c0c5ce;" class="language-javascript "><code class="language-javascript" data-lang="javascript"><span style="color:#b48ead;">const </span><span style="color:#bf616a;">thePort </span><span>= </span><span style="color:#bf616a;">appData</span><span>.</span><span style="color:#bf616a;">dbConfig</span><span>.</span><span style="color:#bf616a;">thePort</span><span>; </span><span style="color:#65737e;">// easy!
</span></code></pre>
<p>It's not too bad in Haskell either, as it auto creates selector functions for records like thus:</p>
<pre data-lang="haskell" style="background-color:#2b303b;color:#c0c5ce;" class="language-haskell "><code class="language-haskell" data-lang="haskell"><span style="color:#8fa1b3;">getPort </span><span style="color:#b48ead;">:: AppConfig -&gt; Int
</span><span>getPort app = thePort (dbConfig app)
</span></code></pre>
<p>(This could also be written as <code>thePort $ dbConfig app</code> but lets keep things simple.)</p>
<p>That all seems well and fine, but how would we change the port in this app config? In mutable JS-land, this would be easy, something like:</p>
<pre data-lang="javascript" style="background-color:#2b303b;color:#c0c5ce;" class="language-javascript "><code class="language-javascript" data-lang="javascript"><span style="color:#bf616a;">appData</span><span>.</span><span style="color:#bf616a;">dbConfig</span><span>.</span><span style="color:#bf616a;">thePort </span><span>= </span><span style="color:#bf616a;">appData</span><span>.</span><span style="color:#bf616a;">dbConfig</span><span>.</span><span style="color:#bf616a;">thePort </span><span>+ </span><span style="color:#d08770;">1</span><span>;
</span></code></pre>
<p>Ignoring for a moment that we have ruined the original object and probably confused anything that depends on it, this is OK, and nicely concise. The immutable way is a bit wordier though...</p>
<pre data-lang="javascript" style="background-color:#2b303b;color:#c0c5ce;" class="language-javascript "><code class="language-javascript" data-lang="javascript"><span style="color:#b48ead;">const </span><span style="color:#bf616a;">newAppData </span><span>= {
</span><span>  ...</span><span style="color:#bf616a;">appData</span><span>,
</span><span>  dbConfig: {
</span><span>    ...</span><span style="color:#bf616a;">appData</span><span>.</span><span style="color:#bf616a;">dbConfig</span><span>,
</span><span>    thePort: </span><span style="color:#bf616a;">appData</span><span>.</span><span style="color:#bf616a;">dbConfig</span><span>.</span><span style="color:#bf616a;">thePort </span><span>+ </span><span style="color:#d08770;">1
</span><span>  }
</span><span>};
</span></code></pre>
<p>And this will only get worse as the levels get deeper. Haskell has a similar problem with deep updates in records, here's the equivalent code:</p>
<pre data-lang="haskell" style="background-color:#2b303b;color:#c0c5ce;" class="language-haskell "><code class="language-haskell" data-lang="haskell"><span style="color:#8fa1b3;">incrementPort </span><span style="color:#b48ead;">:: AppConfig -&gt; AppConfig
</span><span>incrementPort app =
</span><span>    app { dbConfig = (dbConfig app) { thePort = oldPort + </span><span style="color:#d08770;">1</span><span>} }
</span><span>        </span><span style="color:#b48ead;">where</span><span> oldPort = getPort app
</span></code></pre>
<p>The worst thing about the code above is that the only really relevant part is <code>thePort = oldPort + 1</code>. Urgh. What's the solution then? Lens!</p>
<p>A lens captures the idea of both a <code>getter</code> and a <code>setter</code> of a piece of data and a sub-part of it. Here is one for getting <code>title</code> from an <code>AppConfig</code>.</p>
<pre data-lang="haskell" style="background-color:#2b303b;color:#c0c5ce;" class="language-haskell "><code class="language-haskell" data-lang="haskell"><span style="color:#8fa1b3;">titleLens </span><span style="color:#b48ead;">:: Lens</span><span>&#39; </span><span style="color:#b48ead;">AppConfig String
</span><span>titleLens = lens title (\app new -&gt; app { title = new } )
</span></code></pre>
<p>We can get the title of the app using <code>view</code>:</p>
<pre data-lang="haskell" style="background-color:#2b303b;color:#c0c5ce;" class="language-haskell "><code class="language-haskell" data-lang="haskell"><span>title = view titleLens appData
</span><span>
</span><span style="color:#65737e;">-- title = &quot;Hello&quot;
</span></code></pre>
<p>We can change the app's title using <code>set</code>:</p>
<pre data-lang="haskell" style="background-color:#2b303b;color:#c0c5ce;" class="language-haskell "><code class="language-haskell" data-lang="haskell"><span>newApp = set titleLens &quot;</span><span style="color:#a3be8c;">New Title</span><span>&quot; appData
</span><span>
</span><span style="color:#65737e;">-- newApp = AppConfig
</span><span style="color:#65737e;">--  { value = Right 100
</span><span style="color:#65737e;">--  , title = &quot;New Title&quot;
</span><span style="color:#65737e;">--  , dbConfig = DbConfig
</span><span style="color:#65737e;">--    { ipAddress = &quot;127.0.0.1&quot;
</span><span style="color:#65737e;">--    , thePort = 8080
</span><span style="color:#65737e;">--    }
</span><span style="color:#65737e;">--  }
</span></code></pre>
<p>Lastly, we can map over the app's title using <code>over</code>:</p>
<pre data-lang="haskell" style="background-color:#2b303b;color:#c0c5ce;" class="language-haskell "><code class="language-haskell" data-lang="haskell"><span>newApp = over titleLens (\a -&gt; a ++ &quot;</span><span style="color:#a3be8c;">!!!</span><span>&quot;) appData
</span><span>
</span><span style="color:#65737e;">-- newApp = AppConfig
</span><span style="color:#65737e;">--  { value = Right 100
</span><span style="color:#65737e;">--  , title = &quot;Hello!!!&quot;
</span><span style="color:#65737e;">--  , dbConfig = DbConfig
</span><span style="color:#65737e;">--    { ipAddress = &quot;127.0.0.1&quot;
</span><span style="color:#65737e;">--    , thePort = 8080
</span><span style="color:#65737e;">--    }
</span><span style="color:#65737e;">--  }
</span></code></pre>
<p>OK. All so well and good, but this does not solve our deep structure update problem. How might we change <code>thePort</code> inside <code>dbConfig</code> in the same way?</p>
<p>By composing Lenses!</p>
<p>This lens gets us the <code>DbConfig</code> inside <code>AppConfig</code>:</p>
<pre data-lang="haskell" style="background-color:#2b303b;color:#c0c5ce;" class="language-haskell "><code class="language-haskell" data-lang="haskell"><span style="color:#8fa1b3;">dbConfigLens </span><span style="color:#b48ead;">:: Lens</span><span>&#39; </span><span style="color:#b48ead;">AppConfig DbConfig
</span><span>dbConfigLens = lens dbConfig (\app db -&gt; app { dbConfig = db })
</span></code></pre>
<p>And this one gets us <code>thePort</code> inside <code>DbConfig</code>:</p>
<pre data-lang="haskell" style="background-color:#2b303b;color:#c0c5ce;" class="language-haskell "><code class="language-haskell" data-lang="haskell"><span style="color:#8fa1b3;">portLens </span><span style="color:#b48ead;">:: Lens</span><span>&#39; </span><span style="color:#b48ead;">DbConfig Int
</span><span>portLens = lens thePort (\db port -&gt; db { thePort = port } )
</span></code></pre>
<p>But by composing them together we get a lens that takes us from <code>AppConfig</code> all the way to <code>thePort</code>:</p>
<pre data-lang="haskell" style="background-color:#2b303b;color:#c0c5ce;" class="language-haskell "><code class="language-haskell" data-lang="haskell"><span style="color:#8fa1b3;">fullPortLens </span><span style="color:#b48ead;">:: Lens</span><span>&#39; </span><span style="color:#b48ead;">AppConfig Int
</span><span>fullPortLens = dbConfigLens . portLens
</span></code></pre>
<p>(Function composition with the <code>.</code> operator usually means that the right-hand function is run first, and then the left. With lenses, it makes more sense if we read from left to right, so if you squint it looks a little like javascript: <code>fullPort = dbConfig.port</code>. Kind of. Just nod and let's not mention this again.)</p>
<p>Let's use them to look at the port!</p>
<pre data-lang="haskell" style="background-color:#2b303b;color:#c0c5ce;" class="language-haskell "><code class="language-haskell" data-lang="haskell"><span>port = view fullPortLens appData
</span><span style="color:#65737e;">-- port = 8080
</span></code></pre>
<p>To choose a new port!</p>
<pre data-lang="haskell" style="background-color:#2b303b;color:#c0c5ce;" class="language-haskell "><code class="language-haskell" data-lang="haskell"><span>newApp = set fullPortLens </span><span style="color:#d08770;">9090</span><span> appData
</span><span style="color:#65737e;">-- newApp = AppConfig
</span><span style="color:#65737e;">--  { value = Right 100
</span><span style="color:#65737e;">--  , title = &quot;Hello&quot;
</span><span style="color:#65737e;">--  , dbConfig = DbConfig
</span><span style="color:#65737e;">--    { ipAddress = &quot;127.0.0.1&quot;
</span><span style="color:#65737e;">--    , thePort = 9090
</span><span style="color:#65737e;">--    }
</span><span style="color:#65737e;">--  }
</span></code></pre>
<p>Or to increment the port by <code>1</code>, for some reason!</p>
<pre data-lang="haskell" style="background-color:#2b303b;color:#c0c5ce;" class="language-haskell "><code class="language-haskell" data-lang="haskell"><span>newApp = over fullPortLens (+</span><span style="color:#d08770;">1</span><span>) appData
</span><span style="color:#65737e;">-- newApp = AppConfig
</span><span style="color:#65737e;">--  { value = Right 100
</span><span style="color:#65737e;">--  , title = &quot;Hello&quot;
</span><span style="color:#65737e;">--  , dbConfig = DbConfig
</span><span style="color:#65737e;">--    { ipAddress = &quot;127.0.0.1&quot;
</span><span style="color:#65737e;">--    , thePort = 8081
</span><span style="color:#65737e;">--    }
</span><span style="color:#65737e;">--  }
</span></code></pre>
<p>Look at all the things we've done with not too much code. We are now surely mighty hackers. A small disclaimer, the family of things that <code>Lens</code> is a part of are called <code>Optics</code>, and <code>Lens</code> is only the beginning. Next time, we'll look at another variation on <code>Lens</code> called <code>Prism</code>, and see how it let's us interact with that <code>Either</code> type we've conveniently ignored in these examples.</p>
<p>Make sense? If not, why not <a href="/contact.html">get in touch</a>?</p>
<p>Further reading:</p>
<p><a href="http://randycoulman.com/blog/2016/07/12/thinking-in-ramda-lenses/">Thinking in Ramda: Lenses</a></p>
<p><a href="https://www.schoolofhaskell.com/school/to-infinity-and-beyond/pick-of-the-week/a-little-lens-starter-tutorial">A Little Lens Starter Tutorial</a></p>


    </main>

    <footer>
      <p><a href="mailto:danieljamesharvey@gmail.com">Contact</a> |
      <a href="https://github.com/danieljharvey">Github</a></p>
      <p>Links for nerds:
        <a href="/atom.xml">atom</a>
        <a href="/rss.xml">rss</a></p>

    </footer>
</body>

</html>
